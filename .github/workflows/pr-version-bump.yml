name: Bump version on PR

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

env:
  PBXPROJ_PATH: Saga/Saga.xcodeproj/project.pbxproj

jobs:
  bump:
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch main
        run: git fetch origin main

      - name: Extract PR info
        id: prinfo
        run: |
          set -euo pipefail
          info_output="$(swift scripts/versioning.swift pr-info --event "$GITHUB_EVENT_PATH")"
          release_type="$(echo "$info_output" | awk -F= '/^RELEASE_TYPE=/{print $2}')"
          pr_updated_epoch="$(echo "$info_output" | awk -F= '/^PR_UPDATED_EPOCH=/{print $2}')"
          if [[ -z "$release_type" || -z "$pr_updated_epoch" ]]; then
            echo "Failed to parse PR info" >&2
            exit 1
          fi
          echo "release_type=$release_type" >> "$GITHUB_OUTPUT"
          echo "pr_updated_epoch=$pr_updated_epoch" >> "$GITHUB_OUTPUT"

      - name: Read base version/build from main
        id: base
        run: |
          set -euo pipefail
          base_file="$(mktemp)"
          git show origin/main:"$PBXPROJ_PATH" > "$base_file"
          base_output="$(swift scripts/versioning.swift read --path "$base_file")"
          base_version="$(echo "$base_output" | awk -F= '/^VERSION=/{print $2}')"
          base_build="$(echo "$base_output" | awk -F= '/^BUILD=/{print $2}')"
          if [[ -z "$base_version" || -z "$base_build" ]]; then
            echo "Failed to read base version/build" >&2
            exit 1
          fi
          echo "version=$base_version" >> "$GITHUB_OUTPUT"
          echo "build=$base_build" >> "$GITHUB_OUTPUT"

      - name: Compute target version/build
        id: bump
        run: |
          set -euo pipefail
          bump_output="$(swift scripts/versioning.swift bump \
            --path "$PBXPROJ_PATH" \
            --base-version "${{ steps.base.outputs.version }}" \
            --base-build "${{ steps.base.outputs.build }}" \
            --release-type "${{ steps.prinfo.outputs.release_type }}" \
            --pr-updated "${{ steps.prinfo.outputs.pr_updated_epoch }}")"
          version_from="$(echo "$bump_output" | awk -F= '/^VERSION_FROM=/{print $2}')"
          version_to="$(echo "$bump_output" | awk -F= '/^VERSION_TO=/{print $2}')"
          build_from="$(echo "$bump_output" | awk -F= '/^BUILD_FROM=/{print $2}')"
          build_to="$(echo "$bump_output" | awk -F= '/^BUILD_TO=/{print $2}')"
          release_type="$(echo "$bump_output" | awk -F= '/^RELEASE_TYPE=/{print $2}')"
          echo "version_from=$version_from" >> "$GITHUB_OUTPUT"
          echo "version_to=$version_to" >> "$GITHUB_OUTPUT"
          echo "build_from=$build_from" >> "$GITHUB_OUTPUT"
          echo "build_to=$build_to" >> "$GITHUB_OUTPUT"
          echo "release_type=$release_type" >> "$GITHUB_OUTPUT"

      - name: Commit version bump
        id: commit
        if: github.actor != 'github-actions[bot]'
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git add "$PBXPROJ_PATH"
          git -c user.name="github-actions[bot]" \
            -c user.email="41898282+github-actions[bot]@users.noreply.github.com" \
            commit -m "Bump version to ${{ steps.bump.outputs.version_to }} (${{ steps.bump.outputs.build_to }})"
          git push
          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Update PR metadata block
        uses: actions/github-script@v7
        if: github.actor != 'github-actions[bot]'
        with:
          script: |
            const { execFileSync } = require("child_process");
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;
            const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number });
            const body = pr.body || "";
            const args = [
              "scripts/versioning.swift",
              "update-metadata",
              "--from-version", process.env.VERSION_FROM,
              "--to-version", process.env.VERSION_TO,
              "--from-build", process.env.BUILD_FROM,
              "--to-build", process.env.BUILD_TO,
              "--release-type", process.env.RELEASE_TYPE
            ];
            const newBody = execFileSync("swift", args, { input: body }).toString();
            if (newBody !== body) {
              await github.rest.pulls.update({ owner, repo, pull_number, body: newBody });
            }
        env:
          VERSION_FROM: ${{ steps.bump.outputs.version_from }}
          VERSION_TO: ${{ steps.bump.outputs.version_to }}
          BUILD_FROM: ${{ steps.bump.outputs.build_from }}
          BUILD_TO: ${{ steps.bump.outputs.build_to }}
          RELEASE_TYPE: ${{ steps.bump.outputs.release_type }}
